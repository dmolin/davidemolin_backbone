module.exports = function (grunt) {

    var glob = require("glob-all"),
        fs   = require("fs"),
        path = require("path"),
        _ = require("underscore");

    grunt.registerTask('genpackageindex', 'Generate package index files', function(){
        var opts = grunt.task.current.options();

        //go through the folders from this root and generate an index file for each one of them
        _.each(glob.sync(opts.files), checkFolder);
    });

    function checkFolder(f) {
        //console.log("checking ", f);
        if(fs.statSync(f).isDirectory()) {
            generateIndex(f);
        }
    }

    function generateIndex(dir) {
        var output = [];
        var lastPathToken = path.basename(dir),
            isModule = false,
            moduleName = null;

        if(/modules$/.test(path.dirname(dir))) {
            isModule = true;
            moduleName = lastPathToken[0].toUpperCase() + lastPathToken.substring(1) + "Module";
        }

        output.push("//----------------------------------------------------");
        output.push("// NOTE: DO NOT Modify this file! it's automatically generated by a Grunt task (see build/tasks/genpackageindex.js)");
        output.push("//----------------------------------------------------");

        if(isModule) {
            output.push("var " + moduleName + " = {");
        } else {
            output.push("module.exports = {");
        }


        files = glob.sync([
            dir + "/*",
            "!" + dir + "/**/deps.js",
            "!" + dir + "/**/index.js",
            "!" + dir + "/**/templates.js"
            ], {mark:true});

        _.each(files, function(file, index, list) {
            var ext = path.extname(file);
            var key = path.basename(file, ext);

            //only consider js files and folders too
            if(ext !== ".js" && file[file.length-1] !== "/") return;

            //strip trailing "/" if folder
            if(file[file.length-1] === "/") { file = file.substring(0, file.length-1); }

            output.push( "  '" + key + "': require('./" + key + "')" + (index < list.length-1 ? "," : "" ));
        });
        output.push("};");

        if(isModule) {
            output.push("module.exports = " + moduleName + ";");
        }
        fs.writeFileSync(dir + "/index.js", output.join('\n'));
    }
};
